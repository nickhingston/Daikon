<!DOCTYPE html>

<!-- Test: Typical fullscreen usage; autoload an image and overlay. -->

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <script type="text/javascript" src="../build/daikon.js"></script>

    <script type="text/javascript">
        function clearLog() {
            var logger = document.getElementById('results');
            logger.innerHTML = "";
        }

        function readDICOM(name, buf) {
            clearLog();
            console.log("File: " + name);
            console.log("");
            var data = new DataView(buf);
            daikon.Parser.verbose = true;
            const start = new Date().valueOf();
            var image = daikon.Series.parseImage(data);
            console.log("parsed:" + (new Date().valueOf() - start));
            if (image === null) {
                console.error(daikon.Series.parserError);
            } else if (image.hasPixelData()) {
                var pixelData = image.getInterpretedData(true, false, 0);
                console.log("get pix data:" + (new Date().valueOf() - start));
                var canvas = document.getElementById('canvas');
                canvas.width = image.getCols();
                canvas.height = image.getRows();
                var ctx = canvas.getContext('2d');
                var imageData = ctx.createImageData(image.getCols(), image.getRows())
                console.log("create image data:" + (new Date().valueOf() - start));
                var pos = 0;
                if (image.getDataType() === daikon.Image.BYTE_TYPE_RGB) {
                    const nSamples = image.getNumberOfSamplesPerPixel();
                    if (image.getPlanarConfig() && nSamples === 3) {
                        // planar config 1 = RRR...GGG...BBB
                        const length = pixelData.length / 3;
                        for (var i = 0; i < length; i += 1) {
                            const r = pixelData[i];
                            const g = pixelData[i + length];
                            const b = pixelData[i + length * 2];
                            imageData.data[pos++] = r;
                            imageData.data[pos++] = g;
                            imageData.data[pos++] = b;
                            imageData.data[pos++] = 255; // opaque alpha
                        }
                    }
                    else {
                        // planar config 0 = RGBRGBRGB...
                        for (var i = 0; i < pixelData.length; i += 3) {
                            const r = pixelData[i];
                            const g = pixelData[i + 1];
                            const b = pixelData[i + 2];
                            imageData.data[pos++] = r;
                            imageData.data[pos++] = g;
                            imageData.data[pos++] = b;
                            imageData.data[pos++] = 255; // opaque alpha
                        }
                    }
                }
                else {
                    // greyscale...
                    
                    // calculate bit shift for colour depths > 8bit greyscale
                    const storedBits = image.getBitsStored();
                    const bitShift = (storedBits % 8) + ((Math.trunc(storedBits/8) - 1) * 8);

                    for (var i = 0; i < pixelData.length; i++) {
                        var grey = pixelData[i] >> bitShift;
                        imageData.data[pos++] = grey;
                        imageData.data[pos++] = grey;
                        imageData.data[pos++] = grey;
                        imageData.data[pos++] = 255; // opaque alpha
                    }
                }
                console.log("encoded image data:" + (new Date().valueOf() - start));
                ctx.fillStyle = "black"; // this is default anyway
                ctx.fillRect(0, 0, 1024, 1024);
                ctx.putImageData(imageData, 0, 0, 0, 0, image.getCols(), image.getRows());
                console.log("display:" + (new Date().valueOf() - start));
                
                var oldCanvas = document.getElementById("canvas2");
                if (oldCanvas) {
                    oldCanvas.remove();
                }
                const startRender = new Date().valueOf();
                var canvas2 = image.render(0);
                console.log("GPU render time:" + (new Date().valueOf() - startRender));
                canvas2.style = "position:relative; width:1024px; height:1024px;";
                canvas2.id = "canvas2";
                document.getElementsByTagName('body')[0].appendChild(canvas2);
            }
        }

        function makeSlice(file, start, length) {
            var fileType = (typeof File);

            if (fileType === 'undefined') {
                return function () { };
            }

            if (File.prototype.slice) {
                return file.slice(start, start + length);
            }

            if (File.prototype.mozSlice) {
                return file.mozSlice(start, length);
            }

            if (File.prototype.webkitSlice) {
                return file.webkitSlice(start, length);
            }

            return null;
        }

        function readFile(file) {
            var blob = makeSlice(file, 0, file.size);

            var reader = new FileReader();

            reader.onloadend = function (evt) {
                if (evt.target.readyState === FileReader.DONE) {
                    readDICOM(file.name, evt.target.result);
                }
            };

            reader.readAsArrayBuffer(blob);
        }

        function handleFileSelect(evt) {
            var files = evt.target.files;
            readFile(files[0]);
        }
    </script>

    <title>Daikon Test</title>
</head>

<body>

    <div id="select" style="font-family:sans-serif">
        <h3>Daikon &mdash; JavaScript DICOM Parser</h3>
        <h4>
            <a href="https://github.com/rii-mango/Daikon">https://github.com/rii-mango/Daikon</a>
        </h4>
        <p>Select a file:
            <input type="file" id="file" name="files" />
        </p>
        <hr />
    </div>

    <div id="results" style="font-family:sans-serif"></div>


    <script type="text/javascript">
        var old = console.log;
        var logger = document.getElementById('results');

        console.error = console.log = function (message) {
            var str;

            if (typeof message == 'object') {
                str = (JSON && JSON.stringify ? JSON.stringify(message) : message) + '<br />';
            } else {
                str = message + '<br />';
            }

            str = str.replace(/^\s*/mg, function (x) { return new Array(++x.length).join('&nbsp;&nbsp;') });
            str = str.replace(/(?:\r\n|\r|\n)/g, '<br />');

            if (str.indexOf("Private Data") != -1) {
                logger.innerHTML += ("<span class='private'>" + str + "</span>");
            } else {
                logger.innerHTML += str;
            }
        };

        document.getElementById('file').addEventListener('change', handleFileSelect, false);
    </script>
    <canvas id='canvas' width="1024" height="1024" style="position:relative; width:1024px; height:1024px;"></canvas>
</body>

</html>